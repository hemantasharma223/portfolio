<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visitors Full Data</title>
<!-- Bootstrap CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
  body { 
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
  }
  
  .main-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin: 20px auto;
    max-width: 98%;
  }
  
  .header-section {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 25px;
    border-radius: 15px 15px 0 0;
    margin-bottom: 0;
  }
  
  .header-section h1 {
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .table-controls {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .table-responsive {
    max-height: 70vh;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin: 20px;
  }
  
  .table {
    font-size: 13px;
    margin-bottom: 0;
  }
  
  .table th {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    border: none;
    font-weight: 600;
    white-space: nowrap;
    min-width: 120px;
  }
  
  .table td {
    vertical-align: top;
    min-width: 120px;
    max-width: 250px;
  }
  
  .table tbody tr:hover {
    background-color: rgba(76, 175, 80, 0.1);
    transition: background-color 0.2s ease;
  }
  
  .json-cell {
    max-height: 120px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    background: #f8f9fa;
    border-radius: 4px;
    padding: 8px;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  .loading-spinner {
    text-align: center;
    padding: 40px;
  }
  
  .error-alert {
    margin: 20px;
  }
  
  .pagination-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 0 0 15px 15px;
    border-top: 1px solid #dee2e6;
  }
  
  .pagination-info {
    color: #6c757d;
    font-size: 14px;
  }
  
  .entries-selector select {
    width: auto;
    display: inline-block;
  }
  
  .search-box {
    max-width: 300px;
  }
  
  .stats-cards {
    padding: 0 20px 20px 20px;
  }
  
  .stat-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 10px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
  }
  
  .bg-primary-gradient { background: linear-gradient(135deg, #007bff, #0056b3); }
  .bg-success-gradient { background: linear-gradient(135deg, #28a745, #1e7e34); }
  .bg-info-gradient { background: linear-gradient(135deg, #17a2b8, #117a8b); }
  .bg-warning-gradient { background: linear-gradient(135deg, #ffc107, #e0a800); }
  
  @media (max-width: 768px) {
    .main-container {
      margin: 10px;
    }
    .header-section {
      padding: 15px;
    }
    .table-controls {
      padding: 15px;
    }
    .table-responsive {
      margin: 10px;
    }
  }
</style>
</head>
<body>

<div class="container-fluid">
  <div class="main-container">
    <!-- Header -->
    <div class="header-section">
      <h1><i class="bi bi-people-fill"></i> Visitors Analytics Dashboard</h1>
      <p class="mb-0">Comprehensive visitor tracking and analysis</p>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-cards">
      <div class="row g-3 mb-0">
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card border-0 h-100">
            <div class="card-body d-flex align-items-center">
              <div class="stat-icon bg-primary-gradient me-3">
                <i class="bi bi-people"></i>
              </div>
              <div>
                <h6 class="card-title mb-0 text-muted">Total Visitors</h6>
                <h4 class="mb-0 text-primary" id="total-visitors">-</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card border-0 h-100">
            <div class="card-body d-flex align-items-center">
              <div class="stat-icon bg-success-gradient me-3">
                <i class="bi bi-geo-alt"></i>
              </div>
              <div>
                <h6 class="card-title mb-0 text-muted">Unique Locations</h6>
                <h4 class="mb-0 text-success" id="unique-locations">-</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card border-0 h-100">
            <div class="card-body d-flex align-items-center">
              <div class="stat-icon bg-info-gradient me-3">
                <i class="bi bi-browser-chrome"></i>
              </div>
              <div>
                <h6 class="card-title mb-0 text-muted">Unique Browsers</h6>
                <h4 class="mb-0 text-info" id="unique-browsers">-</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stat-card border-0 h-100">
            <div class="card-body d-flex align-items-center">
              <div class="stat-icon bg-warning-gradient me-3">
                <i class="bi bi-clock"></i>
              </div>
              <div>
                <h6 class="card-title mb-0 text-muted">Latest Visit</h6>
                <h6 class="mb-0 text-warning" id="latest-visit">-</h6>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Controls -->
    <div class="table-controls">
      <div class="row align-items-center g-3">
        <div class="col-md-3">
          <div class="entries-selector d-flex align-items-center">
            <label class="form-label me-2 mb-0">Show</label>
            <select class="form-select form-select-sm" id="entries-per-page">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="ms-2 text-muted">entries</span>
          </div>
        </div>
        <div class="col-md-6 d-flex justify-content-center">
          <div class="pagination-info">
            <span id="pagination-info">Showing 0 to 0 of 0 entries</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="search-box">
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" placeholder="Search visitors..." id="search-input">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading/Error States -->
    <div id="loading" class="loading-spinner">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading visitor data...</p>
    </div>

    <div id="error-message" class="error-alert d-none">
      <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div id="error-text">Error loading data</div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive" id="table-container" style="display:none;">
      <table class="table table-striped table-hover" id="visitors-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>IP Address</th>
            <th>Location Info</th>
            <th>Client Details</th>
            <th>Browser Info</th>
            <th>Screen Resolution</th>
            <th>Color Depth</th>
            <th>Device Memory</th>
            <th>CPU Cores</th>
            <th>Connection</th>
            <th>Timezone</th>
            <th>Referrer</th>
            <th>User Agent</th>
            <th>Platform</th>
            <th>Language</th>
            <th>Plugins</th>
            <th>Battery Info</th>
            <th>Pointer Types</th>
            <th>Touch Support</th>
            <th>Do Not Track</th>
            <th>Visit Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" id="pagination-container" style="display:none;">
      <div class="row align-items-center">
        <div class="col-md-6">
          <nav aria-label="Table pagination">
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
          </nav>
        </div>
        <div class="col-md-6 text-end">
          <button class="btn btn-outline-primary btn-sm me-2" id="refresh-btn">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
          <button class="btn btn-outline-success btn-sm" id="export-btn">
            <i class="bi bi-download"></i> Export CSV
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
  let allData = [];
  let filteredData = [];
  let currentPage = 1;
  let entriesPerPage = 25;

  function escapeHtml(text) {
    return $('<div>').text(text).html();
  }

  function prettyJson(jsonStr) {
    if(!jsonStr) return '';
    try {
      var obj = JSON.parse(jsonStr);
      return JSON.stringify(obj, null, 2);
    } catch(e) {
      return escapeHtml(jsonStr);
    }
  }

  function updateStats() {
    const totalVisitors = allData.length;
    const uniqueLocations = new Set(allData.map(v => {
      try {
        const geo = JSON.parse(v.geo_json || '{}');
        return geo.country || 'Unknown';
      } catch(e) { return 'Unknown'; }
    })).size;
    
    const uniqueBrowsers = new Set(allData.map(v => {
      const ua = v.user_agent || '';
      if(ua.includes('Chrome')) return 'Chrome';
      if(ua.includes('Firefox')) return 'Firefox';
      if(ua.includes('Safari')) return 'Safari';
      if(ua.includes('Edge')) return 'Edge';
      return 'Other';
    })).size;

    const latestVisit = allData.length > 0 ? 
      new Date(Math.max(...allData.map(v => new Date(v.visit_time || 0)))).toLocaleDateString() : '-';

    $('#total-visitors').text(totalVisitors);
    $('#unique-locations').text(uniqueLocations);
    $('#unique-browsers').text(uniqueBrowsers);
    $('#latest-visit').text(latestVisit);
  }

  function filterData() {
    const searchTerm = $('#search-input').val().toLowerCase();
    if(!searchTerm) {
      filteredData = [...allData];
    } else {
      filteredData = allData.filter(visitor => {
        return Object.values(visitor).some(value => 
          String(value).toLowerCase().includes(searchTerm)
        );
      });
    }
    currentPage = 1;
    renderTable();
  }

  function renderTable() {
    const startIndex = (currentPage - 1) * entriesPerPage;
    const endIndex = startIndex + entriesPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    const tbody = $('#visitors-table tbody');
    tbody.empty();

    pageData.forEach(function(v) {
      const row = $('<tr>');
      
      // Build row content
      const cells = [
        escapeHtml(v.id),
        escapeHtml(v.ip_address),
        `<div class="json-cell">${prettyJson(v.geo_json)}</div>`,
        `<div class="json-cell">${prettyJson(v.client_json)}</div>`,
        `<div class="json-cell">${escapeHtml(v.browser_info || '')}</div>`,
        escapeHtml(v.screen_resolution || ''),
        escapeHtml(v.color_depth || ''),
        escapeHtml(v.device_memory || ''),
        escapeHtml(v.hardware_concurrency || ''),
        `<div class="json-cell">${prettyJson(v.connection_info)}</div>`,
        escapeHtml(v.timezone || ''),
        `<div style="max-width: 200px; word-break: break-all;">${escapeHtml(v.referrer || '')}</div>`,
        `<div class="json-cell">${escapeHtml(v.user_agent || '')}</div>`,
        escapeHtml(v.platform || ''),
        escapeHtml(v.accept_language || ''),
        `<div class="json-cell">${prettyJson(v.plugins)}</div>`,
        `<div class="json-cell">${prettyJson(v.battery_info)}</div>`,
        escapeHtml(v.pointer_types || ''),
        escapeHtml(v.touch_support || ''),
        escapeHtml(v.do_not_track || ''),
        escapeHtml(v.visit_time || '')
      ];

      cells.forEach(cellContent => {
        row.append(`<td>${cellContent}</td>`);
      });

      tbody.append(row);
    });

    updatePagination();
    updatePaginationInfo();
  }

  function updatePagination() {
    const totalPages = Math.ceil(filteredData.length / entriesPerPage);
    const pagination = $('#pagination');
    pagination.empty();

    if(totalPages <= 1) return;

    // Previous button
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    pagination.append(`
      <li class="page-item ${prevDisabled}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">
          <i class="bi bi-chevron-left"></i>
        </a>
      </li>
    `);

    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    if(startPage > 1) {
      pagination.append('<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>');
      if(startPage > 2) {
        pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
      }
    }

    for(let i = startPage; i <= endPage; i++) {
      const active = i === currentPage ? 'active' : '';
      pagination.append(`
        <li class="page-item ${active}">
          <a class="page-link" href="#" data-page="${i}">${i}</a>
        </li>
      `);
    }

    if(endPage < totalPages) {
      if(endPage < totalPages - 1) {
        pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
      }
      pagination.append(`<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`);
    }

    // Next button
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    pagination.append(`
      <li class="page-item ${nextDisabled}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">
          <i class="bi bi-chevron-right"></i>
        </a>
      </li>
    `);
  }

  function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * entriesPerPage + 1;
    const endIndex = Math.min(currentPage * entriesPerPage, filteredData.length);
    const total = filteredData.length;
    
    $('#pagination-info').text(`Showing ${startIndex} to ${endIndex} of ${total} entries`);
  }

  // Event handlers
  $('#entries-per-page').on('change', function() {
    entriesPerPage = parseInt($(this).val());
    currentPage = 1;
    renderTable();
  });

  $('#search-input').on('keyup', debounce(filterData, 300));

  $(document).on('click', '.page-link', function(e) {
    e.preventDefault();
    const page = parseInt($(this).data('page'));
    if(page && page !== currentPage) {
      currentPage = page;
      renderTable();
    }
  });

  $('#refresh-btn').on('click', loadData);

  $('#export-btn').on('click', function() {
    // Simple CSV export
    let csv = 'ID,IP Address,Location,Visit Time\n';
    filteredData.forEach(v => {
      csv += `"${v.id}","${v.ip_address}","${v.geo_json}","${v.visit_time}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'visitors_data.csv';
    a.click();
    window.URL.revokeObjectURL(url);
  });

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function loadData() {
    $('#loading').show();
    $('#error-message').addClass('d-none');
    $('#table-container, #pagination-container').hide();

    $.ajax({
      url: 'https://karkiandasuppliers.com/fetch_visitors.php',
      method: 'GET',
      dataType: 'json',
      timeout: 10000,
      success: function(data) {
        if(data.error) {
          showError('Error loading data: ' + data.error);
          return;
        }
        
        if(data.length === 0) {
          showError('No visitor data found.');
          return;
        }

        allData = data;
        filteredData = [...allData];
        updateStats();
        renderTable();
        
        $('#loading').hide();
        $('#table-container, #pagination-container').show();
      },
      error: function(xhr, status, error) {
        showError('Failed to load data: ' + error);
      }
    });
  }

  function showError(message) {
    $('#loading').hide();
    $('#error-text').text(message);
    $('#error-message').removeClass('d-none');
  }

  // Initial load
  loadData();
});
</script>
</body>
</html>
